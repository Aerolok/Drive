<div class="modal fade" id="editarCarpetaModal" tabindex="-1" role="dialog" aria-labelledby="editarCarpetaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-header">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="header-text">
                        <h4 class="modal-title">Editar Carpeta</h4>
                        <p class="modal-subtitle">Modifica la información de la carpeta</p>
                    </div>
                </div>
            </div>
            
            <form id="editarCarpetaForm" method="post">
                <div class="modal-body modern-body">
                    {% csrf_token %}
                    <input type="hidden" id="carpeta_id" name="carpeta_id" value="{{ carpeta.id }}">
                    
                    <div class="form-group">
                        <label for="nombre" class="form-label">
                            <i class="fas fa-tag"></i>
                            Nombre de la carpeta
                        </label>
                        <input type="text" 
                               class="form-control modern-input" 
                               id="nombre" 
                               name="nombre" 
                               value="{{ carpeta.nombre }}"
                               placeholder="Ej: Documentos importantes"
                               required>
                        <div class="input-help">
                            <i class="fas fa-info-circle"></i>
                            No se permiten caracteres especiales como / \ : * ? " < > |
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="descripcion" class="form-label">
                            <i class="fas fa-align-left"></i>
                            Descripción
                        </label>
                        <textarea class="form-control modern-input" 
                                  id="descripcion" 
                                  name="descripcion" 
                                  rows="3"
                                  placeholder="Describe el contenido de esta carpeta (opcional)">{{ carpeta.descripcion }}</textarea>
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <div class="toggle-info">
                                <div class="toggle-header">
                                    <i class="fas fa-globe"></i>
                                    <span>Carpeta pública</span>
                                </div>
                                <p class="toggle-desc">Permitir acceso a todos los usuarios</p>
                            </div>
                            <div class="toggle-switch">
                                <input type="checkbox" 
                                       id="publica" 
                                       name="publica"
                                       class="toggle-input"
                                       {% if carpeta.publica %}checked{% endif %}>
                                <label for="publica" class="toggle-label">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="info-content">
                            <strong>Consejo:</strong> Las carpetas públicas son visibles para todos los usuarios del sistema.
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer modern-footer">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* CSS ULTRA-ESPECÍFICO Y AISLADO PARA MODAL EDITAR CARPETA */
/* Reseteo completo y aislamiento total */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content,
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content * {
    box-sizing: border-box !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    outline: none !important;
    text-decoration: none !important;
    list-style: none !important;
    background: transparent !important;
    color: inherit !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
    font-size: 14px !important;
    font-weight: normal !important;
    line-height: 1.5 !important;
}

/* Modal principal */
div#editarCarpetaModal.modal.fade {
    z-index: 9999 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog {
    max-width: 550px !important;
    margin: 1.75rem auto !important;
    position: relative !important;
    width: auto !important;
    pointer-events: none !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content {
    position: relative !important;
    display: flex !important;
    flex-direction: column !important;
    width: 100% !important;
    pointer-events: auto !important;
    background: #ffffff !important;
    border: none !important;
    border-radius: 16px !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15) !important;
    overflow: hidden !important;
}

/* Header del modal */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 24px !important;
    background: linear-gradient(135deg, #2c5aa0 0%, #46A29F 100%) !important;
    border-bottom: none !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .header-content {
    display: flex !important;
    align-items: center !important;
    gap: 16px !important;
    width: 100% !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .header-icon {
    width: 48px !important;
    height: 48px !important;
    background: rgba(255, 255, 255, 0.2) !important;
    border-radius: 12px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 20px !important;
    color: #ffffff !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .header-icon i {
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .header-text h4 {
    margin: 0 !important;
    font-size: 20px !important;
    font-weight: 600 !important;
    color: #ffffff !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .modal-subtitle {
    margin: 4px 0 0 0 !important;
    font-size: 14px !important;
    opacity: 0.9 !important;
    color: #ffffff !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .btn-close {
    background: none !important;
    border: none !important;
    color: #ffffff !important;
    font-size: 24px !important;
    cursor: pointer !important;
    padding: 0 !important;
    width: 32px !important;
    height: 32px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 6px !important;
    transition: background-color 0.2s ease !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header .btn-close:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

/* Body del modal */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body {
    padding: 20px !important;
    background: #ffffff !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .form-group {
    margin-bottom: 16px !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .form-label {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
    margin-bottom: 8px !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .form-label i {
    color: #2c5aa0 !important;
    width: 16px !important;
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body input.form-control,
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body textarea.form-control {
    width: 100% !important;
    padding: 10px 14px !important;
    border: 2px solid #e2e8f0 !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
    outline: none !important;
    resize: vertical !important;
    background: #ffffff !important;
    color: #2d3748 !important;
    box-sizing: border-box !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body input.form-control:focus,
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body textarea.form-control:focus {
    border-color: #2c5aa0 !important;
    box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1) !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .input-help {
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    margin-top: 4px !important;
    font-size: 12px !important;
    color: #718096 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .input-help i {
    color: #2c5aa0 !important;
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

/* Toggle switch */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-container {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 12px 16px !important;
    background: #f8f9fa !important;
    border-radius: 8px !important;
    border: 1px solid #e2e8f0 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-info {
    flex: 1 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-header {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    margin-bottom: 4px !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-header i {
    color: #2c5aa0 !important;
    font-size: 14px !important;
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-header span {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #2d3748 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-desc {
    font-size: 12px !important;
    color: #718096 !important;
    margin: 0 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-switch {
    position: relative !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-input {
    display: none !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-label {
    display: block !important;
    width: 44px !important;
    height: 24px !important;
    background: #cbd5e0 !important;
    border-radius: 12px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    position: relative !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-slider {
    position: absolute !important;
    top: 2px !important;
    left: 2px !important;
    width: 20px !important;
    height: 20px !important;
    background: #ffffff !important;
    border-radius: 50% !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-input:checked + .toggle-label {
    background: linear-gradient(135deg, #2c5aa0 0%, #46A29F 100%) !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .toggle-input:checked + .toggle-label .toggle-slider {
    transform: translateX(20px) !important;
}

/* Info card */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .info-card {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    padding: 16px !important;
    background: #f0f8ff !important;
    border-radius: 8px !important;
    border: 1px solid #bee3f8 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .info-icon {
    width: 40px !important;
    height: 40px !important;
    background: linear-gradient(135deg, #2c5aa0 0%, #46A29F 100%) !important;
    border-radius: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: #ffffff !important;
    font-size: 16px !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .info-icon i {
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body .info-content {
    flex: 1 !important;
    font-size: 13px !important;
    color: #2d3748 !important;
}

/* Footer del modal */
div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-end !important;
    gap: 12px !important;
    padding: 20px !important;
    background: #f8f9fa !important;
    border-top: 1px solid #e2e8f0 !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn {
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    padding: 10px 20px !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    text-decoration: none !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    border: 2px solid transparent !important;
    min-width: 120px !important;
    justify-content: center !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn i {
    font-family: "Font Awesome 6 Free" !important;
    font-weight: 900 !important;
    display: inline-block !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn-secondary {
    background: #ffffff !important;
    color: #6b7280 !important;
    border-color: #d1d5db !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn-secondary:hover {
    background: #f9fafb !important;
    border-color: #9ca3af !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn-primary {
    background: linear-gradient(135deg, #2c5aa0 0%, #46A29F 100%) !important;
    color: #ffffff !important;
    border-color: transparent !important;
}

div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn-primary:hover {
    background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3) !important;
}

/* Responsive */
@media (max-width: 576px) {
    div#editarCarpetaModal.modal.fade .modal-dialog {
        max-width: calc(100% - 2rem) !important;
        margin: 1rem !important;
    }
    
    div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-header {
        padding: 16px !important;
    }
    
    div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-body {
        padding: 16px !important;
    }
    
    div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer {
        padding: 16px !important;
        flex-direction: column !important;
    }
    
    div#editarCarpetaModal.modal.fade .modal-dialog .modal-content .modal-footer .btn {
        width: 100% !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editarCarpetaForm');
    if (form) {
        const nombreInput = document.getElementById('nombre');
        
        // Validación en tiempo real para caracteres especiales
        nombreInput.addEventListener('input', function() {
            const valor = this.value;
            const caracteresProhibidos = /[\/\\:*?"<>|]/;
            
            if (caracteresProhibidos.test(valor)) {
                this.setCustomValidity('No se permiten caracteres especiales como / \\ : * ? " < > |');
                this.style.borderColor = '#e53e3e';
            } else {
                this.setCustomValidity('');
                this.style.borderColor = '#e2e8f0';
            }
        });
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Validaciones
            const nombre = formData.get('nombre').trim();
            
            if (!nombre) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre de la carpeta es obligatorio'
                });
                return;
            }
            
            const caracteresProhibidos = /[\/\\:*?"<>|]/;
            if (caracteresProhibidos.test(nombre)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre contiene caracteres no permitidos'
                });
                return;
            }
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            submitBtn.disabled = true;
            
            const carpetaId = document.getElementById('carpeta_id').value;
            fetch(`/editar_carpeta/${carpetaId}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editarCarpetaModal'));
                    if (modal) modal.hide();
                    
                    // Mostrar éxito y recargar
                    Swal.fire({
                        icon: 'success',
                        title: '¡Carpeta actualizada!',
                        text: 'Los cambios se han guardado correctamente',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    setTimeout(() => location.reload(), 2000);
                } else {
                    let errorMsg = 'Error al actualizar la carpeta';
                    if (data.errors) {
                        errorMsg = Object.values(data.errors).flat().join(', ');
                    }
                    throw new Error(errorMsg);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo actualizar la carpeta. Inténtalo de nuevo.'
                });
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
});
</script>