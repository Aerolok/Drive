{% extends 'layout.html' %}

{% block content %}
<div class="admin-panel">
  <div class="admin-header">
    <h1>Bienvenido, administrador {{ request.user.username }}</h1>
  </div>

  <hr class="linea-turquesa">

  <section class="usuarios-section">
    <div class="section-header">
      <h2>Gestión de Usuarios</h2>
      <button id="btnCrearUsuario" class="btn-principal">+ Crear usuario</button>
    </div>
    <table class="tabla">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Email</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
          {% if not u.is_staff %}
          <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.email }}</td>
            <td>
              <button class="btn-accion btn-editar" data-id="{{ u.id }}">Editar</button>
              <button class="btn-accion btn-eliminar" data-id="{{ u.id }}">Eliminar</button>
            </td>
          </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </section>

  <hr class="linea-turquesa">

  <section class="carpetas-section">
    <div class="section-header">
      <h2>Carpetas y Archivos</h2>
      <button id="btnCrearCarpeta" class="btn-principal">+ Crear carpeta</button>
    </div>

    {% for c in carpetas %}
    <div class="carpeta-container">
      <div class="carpeta-info">
        <h3>{{ c.nombre }}</h3>
        <p><strong>Propietario:</strong> {{ c.usuario.username }}</p>
        <p>{{ c.descripcion }}</p>
      </div>

      <div class="carpeta-archivos">
        <h4>Archivos:</h4>
        {% if c.archivos.all %}
        <table class="tabla">
          <thead>
            <tr>
              <th>Archivo</th>
              <th>Usuario</th>
              <th>Fecha Subida</th>
              <th>Ver</th>
              <th>Descargar</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody>
            {% for archivo in c.archivos.all %}
            <tr>
              <td>{{ archivo.nombre }}</td>
              <td>{{ archivo.usuario.username }}</td>
              <td>{{ archivo.fecha_subida|date:"d/m/Y H:i" }}</td>
              <td><a href="{{ archivo.archivo.url }}" target="_blank">Ver</a></td>
              <td><a href="{{ archivo.archivo.url }}" download>Descargar</a></td>
              <td><button class="btn-accion" onclick="eliminarArchivoAdmin({{ archivo.id }})">Eliminar</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="mensaje-vacio">No hay archivos en esta carpeta.</p>
        {% endif %}
      </div>

      <div class="carpeta-acciones">
        <button class="btn-accion btn-editar-carpeta" data-id="{{ c.id }}">Editar Carpeta</button>
        <button class="btn-accion btn-eliminar-carpeta" data-id="{{ c.id }}">Eliminar Carpeta</button>
      </div>
    </div>
    {% endfor %}
  </section>

  <!-- Ventanas modales flotantes -->
  <div id="modalFondo" class="modal-fondo"></div>
  <div id="modalUsuario" class="modal-contenedor"></div>
  <div id="modalCarpeta" class="modal-contenedor"></div>
  <div id="modalArchivo" class="modal-contenedor"></div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const modalFondo = document.getElementById('modalFondo');
const modalUsuario = document.getElementById('modalUsuario');
const modalCarpeta = document.getElementById('modalCarpeta');
const modalArchivo = document.getElementById('modalArchivo');

function abrirModal(modal, url) {
  fetch(url)
  .then(res => res.text())
  .then(html => {
    modal.innerHTML = html;
    modal.style.display = 'block';
    modalFondo.style.display = 'block';

    const form = modal.querySelector('form');
    if(form) {
      form.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
          body: formData
        })
        .then(r => r.json())
        .then(data => {
          if(data.success){
            Swal.fire({
              icon: 'success',
              title: '¡Éxito!',
              text: 'Operación realizada correctamente',
              timer: 2000,
              showConfirmButton: false
            });
            cerrarModal();
            setTimeout(() => location.reload(), 2000);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Errores: ' + JSON.stringify(data.errors)
            });
          }
        });
      });
    }
  });
}

function cerrarModal() {
  modalUsuario.style.display = 'none';
  modalCarpeta.style.display = 'none';
  modalArchivo.style.display = 'none';
  modalFondo.style.display = 'none';
  modalUsuario.innerHTML = '';
  modalCarpeta.innerHTML = '';
  modalArchivo.innerHTML = '';
}

// Crear usuario
document.getElementById('btnCrearUsuario').onclick = () => abrirModal(modalUsuario, "{% url 'crear_usuario' %}");

// Editar usuario
document.querySelectorAll('.btn-editar').forEach(btn => {
  btn.onclick = () => abrirModal(modalUsuario, `/editar_usuario/${btn.dataset.id}/`);
});

// Eliminar usuario
document.querySelectorAll('.btn-eliminar').forEach(btn => {
  btn.onclick = () => {
    Swal.fire({
      title: '¿Estás seguro?',
      text: "Esta acción eliminará al usuario",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then(result => {
      if(result.isConfirmed){
        fetch(`/eliminar_usuario/${btn.dataset.id}/`, {
          method: 'POST',
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
        })
        .then(r => r.json())
        .then(data => {
          if(data.success){
            Swal.fire({
              icon: 'success',
              title: 'Usuario eliminado',
              timer: 2000,
              showConfirmButton: false
            });
            setTimeout(() => location.reload(), 2000);
          } else {
            Swal.fire('Error', 'No se pudo eliminar el usuario', 'error');
          }
        });
      }
    });
  }
});

// Crear carpeta
document.getElementById('btnCrearCarpeta').onclick = () => abrirModal(modalCarpeta, "{% url 'crear_carpeta' %}");

// Editar carpeta
document.querySelectorAll('.btn-editar-carpeta').forEach(btn => {
  btn.onclick = () => abrirModal(modalCarpeta, `/editar_carpeta/${btn.dataset.id}/`);
});

// Eliminar carpeta
document.querySelectorAll('.btn-eliminar-carpeta').forEach(btn => {
  btn.onclick = () => {
    Swal.fire({
      title: '¿Eliminar carpeta?',
      text: "Esta acción no se puede deshacer",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then(result => {
      if(result.isConfirmed){
        fetch(`/eliminar_carpeta/${btn.dataset.id}/`, {
          method: 'POST',
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
        })
        .then(r => r.json())
        .then(data => {
          if(data.success){
            Swal.fire({
              icon: 'success',
              title: 'Carpeta eliminada',
              timer: 2000,
              showConfirmButton: false
            });
            setTimeout(() => location.reload(), 2000);
          } else {
            Swal.fire('Error', 'No se pudo eliminar la carpeta', 'error');
          }
        });
      }
    });
  }
});

function eliminarArchivoAdmin(id) {
  Swal.fire({
    title: '¿Eliminar archivo?',
    text: "Esta acción no se puede deshacer",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(result => {
    if(result.isConfirmed){
      const formData = new FormData();
      formData.append('archivo_id', id);

      fetch(`/eliminar_archivo/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Archivo eliminado',
            timer: 2000,
            showConfirmButton: false
          });
          setTimeout(() => location.reload(), 2000);
        } else {
          Swal.fire('Error', 'No se pudo eliminar el archivo', 'error');
        }
      })
      .catch(() => Swal.fire('Error', 'Error en la solicitud', 'error'));
    }
  });
}

// Cerrar modal si se hace click fuera
modalFondo.onclick = cerrarModal;
</script>
{% endblock %}
