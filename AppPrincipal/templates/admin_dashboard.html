{% extends 'layout.html' %}

{% block content %}
<style>
  /* Variables CSS para colores institucionales */
  :root {
    --primary-color: #1e3a8a;
    --primary-light: #3b82f6;
    --primary-dark: #1e40af;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    --white: #ffffff;
    --border-radius: 8px;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  }

  /* Reset y base */
  * {
    box-sizing: border-box;
  }

  /* Header de sección limpio */
  .section-header-clean {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 0;
  }

  .header-left .section-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-left .section-title i {
    color: var(--primary-color);
    font-size: 20px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
  }

  /* Botones limpios */
  .btn-clean {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .btn-clean.primary {
    background-color: var(--primary-color);
    color: var(--white);
  }

  .btn-clean.primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-clean.secondary {
    background-color: var(--white);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
  }

  .btn-clean.secondary:hover {
    background-color: var(--gray-50);
    border-color: var(--gray-400);
  }

  /* Toolbar minimalista */
  .toolbar-clean {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 16px 20px;
    background-color: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
  }

  .search-container {
    flex: 1;
    max-width: 400px;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 12px;
    color: var(--gray-400);
    font-size: 14px;
    z-index: 1;
  }

  .search-input-clean {
    width: 100%;
    padding: 10px 12px 10px 36px;
    border: 1px solid var(--gray-300);
    border-radius: var(--border-radius);
    font-size: 14px;
    background-color: var(--white);
    transition: border-color 0.2s ease;
  }

  .search-input-clean:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
  }

  .view-toggle {
    display: flex;
    background-color: var(--gray-100);
    border-radius: var(--border-radius);
    padding: 2px;
  }

  .toggle-btn {
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: var(--gray-600);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
  }

  .toggle-btn.active {
    background-color: var(--white);
    color: var(--primary-color);
    box-shadow: var(--shadow-sm);
  }

  .toggle-btn:hover:not(.active) {
    color: var(--gray-800);
  }

  /* Grid de carpetas limpio */
  .folders-grid-clean {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .folder-card-clean {
    background-color: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }

  .folder-card-clean:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .folder-icon-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }

  .folder-icon-clean {
    width: 48px;
    height: 48px;
    background-color: var(--primary-color);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 20px;
  }

  .folder-menu-trigger {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .folder-menu-trigger:hover {
    background-color: var(--gray-100);
    color: var(--gray-600);
  }

  .folder-info-clean {
    margin-bottom: 16px;
  }

  .folder-name-clean {
    font-size: 16px;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 4px 0;
    line-height: 1.4;
  }

  .folder-desc-clean {
    font-size: 14px;
    color: var(--gray-600);
    margin: 0;
    line-height: 1.4;
  }

  .folder-meta-clean {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--gray-600);
  }

  .meta-item i {
    width: 14px;
    font-size: 12px;
  }

  .text-success {
    color: var(--success-color) !important;
  }

  .text-muted {
    color: var(--gray-400) !important;
  }

  /* Menu contextual */
  .folder-context-menu {
    position: absolute;
    top: 60px;
    right: 20px;
    background-color: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    min-width: 160px;
    display: none;
  }

  .folder-context-menu.show {
    display: block;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    font-size: 14px;
    color: var(--gray-700);
    transition: background-color 0.2s ease;
  }

  .menu-item:hover {
    background-color: var(--gray-50);
  }

  .menu-item.danger {
    color: var(--danger-color);
  }

  .menu-item.danger:hover {
    background-color: #fef2f2;
  }

  .menu-item i {
    width: 16px;
    font-size: 14px;
  }

  /* Vista de lista limpia */
  .folders-list-clean {
    background-color: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .list-header-clean {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 16px;
    padding: 16px 20px;
    background-color: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .list-row-clean {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 16px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background-color 0.2s ease;
    align-items: center;
  }

  .list-row-clean:hover {
    background-color: var(--gray-50);
  }

  .list-row-clean:last-child {
    border-bottom: none;
  }

  .folder-name-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .folder-icon-small {
    color: var(--primary-color);
    font-size: 16px;
  }

  .name-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .name-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-900);
  }

  .desc-text {
    font-size: 12px;
    color: var(--gray-600);
  }

  .files-count-text {
    font-size: 14px;
    color: var(--gray-700);
  }

  .status-public {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--success-color);
    font-weight: 500;
  }

  .status-private {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--gray-500);
    font-weight: 500;
  }

  .owner-text {
    font-size: 14px;
    color: var(--gray-700);
  }

  .actions-row {
    display: flex;
    gap: 8px;
  }

  .action-btn-clean {
    width: 32px;
    height: 32px;
    border: none;
    background-color: transparent;
    color: var(--gray-400);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .action-btn-clean:hover {
    background-color: var(--gray-100);
    color: var(--gray-600);
  }

  .action-btn-clean.danger:hover {
    background-color: #fef2f2;
    color: var(--danger-color);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .section-header-clean {
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .header-actions {
      justify-content: center;
    }

    .toolbar-clean {
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .search-container {
      max-width: none;
    }

    .view-toggle {
      align-self: center;
    }

    .folders-grid-clean {
      grid-template-columns: 1fr;
    }

    .list-header-clean,
    .list-row-clean {
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .list-header-clean > div:not(.col-name),
    .list-row-clean > div:not(.col-name) {
      display: none;
    }
  }

  /* Estados de carga y vacío */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-500);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--gray-300);
  }

  .empty-state h3 {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 8px;
    color: var(--gray-700);
  }

  .empty-state p {
    font-size: 14px;
    margin: 0;
  }

  /* Estilos para el modal de archivos */
  .modal-archivos-popup {
    border-radius: 16px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
  }

  .modal-archivos-title {
    color: var(--primary-color) !important;
    font-size: 24px !important;
    font-weight: 600 !important;
    margin-bottom: 0 !important;
  }

  .modal-archivos-content {
    padding: 0 !important;
  }

  .modal-archivos-container {
    max-height: 600px;
    overflow-y: auto;
  }

  .carpeta-info-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    margin: -20px -20px 20px -20px;
  }

  .carpeta-descripcion {
    font-size: 16px;
    margin-bottom: 12px;
    opacity: 0.9;
  }

  .carpeta-stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
  }

  .stat-item i {
    font-size: 16px;
  }

  .archivos-lista {
    max-height: 400px;
    overflow-y: auto;
    padding: 0 4px;
  }

  .archivo-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    margin-bottom: 12px;
    background: white;
    transition: all 0.2s ease;
  }

  .archivo-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    transform: translateY(-1px);
  }

  .archivo-info {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 1;
  }

  .archivo-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: #f8fafc;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .archivo-details {
    flex: 1;
  }

  .archivo-nombre {
    font-size: 16px;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 4px 0;
  }

  .archivo-meta {
    display: flex;
    gap: 16px;
    margin: 0;
    font-size: 13px;
    color: var(--gray-500);
  }

  .archivo-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .archivo-actions {
    display: flex;
    gap: 8px;
  }

  .btn-archivo-action {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }

  .btn-descargar {
    background-color: #f0f9ff;
    color: #0284c7;
  }

  .btn-descargar:hover {
    background-color: #0284c7;
    color: white;
  }

  .btn-editar {
    background-color: #fef3c7;
    color: #d97706;
  }

  .btn-editar:hover {
    background-color: #d97706;
    color: white;
  }

  .btn-eliminar {
    background-color: #fef2f2;
    color: #dc2626;
  }

  .btn-eliminar:hover {
    background-color: #dc2626;
    color: white;
  }

  .empty-files-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-500);
  }

  .empty-files-state i {
    font-size: 64px;
    margin-bottom: 16px;
    color: var(--gray-300);
  }

  .empty-files-state h3 {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--gray-700);
  }

  .empty-files-state p {
    font-size: 16px;
    margin: 0;
  }

  .modal-actions-footer {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    margin: 20px -20px -20px -20px;
    background: #f8fafc;
    border-radius: 0 0 12px 12px;
    text-align: center;
  }

  .btn-modal-action {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-modal-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
  }

  /* Colores para diferentes tipos de archivos */
  .text-purple { color: #8b5cf6; }
  .text-orange { color: #f97316; }

  /* Scrollbar personalizado para el modal */
  .modal-archivos-container::-webkit-scrollbar,
  .archivos-lista::-webkit-scrollbar {
    width: 6px;
  }

  .modal-archivos-container::-webkit-scrollbar-track,
  .archivos-lista::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .modal-archivos-container::-webkit-scrollbar-thumb,
  .archivos-lista::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 3px;
  }

  .modal-archivos-container::-webkit-scrollbar-thumb:hover,
  .archivos-lista::-webkit-scrollbar-thumb:hover {
    background: var(--secondary-color);
  }
</style>
<div class="admin-panel">
  <!-- Header del Dashboard -->
  <div class="admin-header">
    <div class="header-content">
      <h1><i class="fas fa-tachometer-alt"></i> Panel de Administración</h1>
      <p class="welcome-text">Bienvenido, <strong>{{ request.user.username }}</strong></p>
      {% if periodo_activo %}
        <div class="periodo-activo">
          <i class="fas fa-calendar-check"></i>
          <span>Período Activo: {{ periodo_activo.nombre }}</span>
        </div>
      {% endif %}
    </div>
    <div class="header-actions">
      <!-- Botón movido a la sección de períodos académicos -->
    </div>
  </div>

  <!-- Dashboard de Estadísticas -->
  <section class="dashboard-stats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ total_usuarios }}</h3>
          <p>Usuarios Activos</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-folder"></i>
        </div>
        <div class="stat-content">
          <h3>{{ total_carpetas }}</h3>
          <p>Carpetas Totales</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-file"></i>
        </div>
        <div class="stat-content">
          <h3>{{ total_archivos }}</h3>
          <p>Archivos Almacenados</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-content">
          <h3>{{ periodos.count }}</h3>
          <p>Períodos Académicos</p>
        </div>
      </div>
    </div>
  </section>

  <hr class="linea-turquesa">

  <!-- Navegación por Pestañas -->
  <div class="tab-navigation">
    <button class="tab-btn active" data-tab="usuarios">
      <i class="fas fa-users"></i> Gestión de Usuarios
    </button>
    <button class="tab-btn" data-tab="periodos">
      <i class="fas fa-calendar-alt"></i> Períodos Académicos
    </button>
    <button class="tab-btn" data-tab="carpetas">
      <i class="fas fa-folder-open"></i> Carpetas y Archivos
    </button>
  </div>

  <!-- Contenido de Pestañas -->
  <div class="tab-content">
    
    <!-- Pestaña de Usuarios -->
    <div id="usuarios-tab" class="tab-pane active">
      <div class="section-header">
        <h2><i class="fas fa-users"></i> Gestión de Usuarios</h2>
        <div class="header-controls">
          <div class="search-box">
            <input type="text" id="searchUsuarios" placeholder="Buscar usuarios...">
            <i class="fas fa-search"></i>
          </div>
          <button id="btnCrearUsuario" class="btn-principal">
            <i class="fas fa-user-plus"></i> Crear Usuario
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <table class="tabla modern-table">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Usuario</th>
              <th><i class="fas fa-envelope"></i> Email</th>
              <th><i class="fas fa-calendar"></i> Fecha Registro</th>
              <th><i class="fas fa-folder"></i> Carpetas</th>
              <th><i class="fas fa-file"></i> Archivos</th>
              <th><i class="fas fa-cogs"></i> Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in usuarios %}
              {% if not u.is_staff %}
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar">{{ u.username|first|upper }}</div>
                    <span>{{ u.username }}</span>
                  </div>
                </td>
                <td>{{ u.email }}</td>
                <td>{{ u.date_joined|date:"d/m/Y" }}</td>
                <td>
                  <span class="badge">{{ u.carpeta_set.count }}</span>
                </td>
                <td>
                  <span class="badge">{{ u.archivo_set.count }}</span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-accion btn-editar" data-id="{{ u.id }}" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-accion btn-eliminar" data-id="{{ u.id }}" title="Eliminar">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pestaña de Períodos Académicos -->
    <div id="periodos-tab" class="tab-pane">
      <div class="section-header">
        <h2><i class="fas fa-calendar-alt"></i> Períodos Académicos</h2>
        <div class="header-controls">
          <button id="btnCrearPeriodo" class="btn-principal">
            <i class="fas fa-plus"></i> Nuevo Período
          </button>
        </div>
      </div>

      <div class="periodos-grid">
        {% for periodo in periodos %}
        <div class="periodo-card {% if periodo.activo %}periodo-activo{% endif %}">
          <div class="periodo-header">
            <h3>{{ periodo.nombre }}</h3>
            {% if periodo.activo %}
              <span class="badge badge-success">Activo</span>
            {% else %}
              <span class="badge badge-secondary">Inactivo</span>
            {% endif %}
          </div>
          <div class="periodo-info">
            <p><i class="fas fa-calendar"></i> Año: {{ periodo.año }}</p>
            <p><i class="fas fa-calendar-week"></i> Período: {{ periodo.periodo }}</p>
            <p><i class="fas fa-calendar-day"></i> {{ periodo.fecha_inicio|date:"d/m/Y" }} - {{ periodo.fecha_fin|date:"d/m/Y" }}</p>
          </div>
          <div class="periodo-actions">
            {% if not periodo.activo %}
              <button class="btn-accion btn-activar" data-id="{{ periodo.id }}" title="Activar">
                <i class="fas fa-play"></i> Activar
              </button>
            {% endif %}
            <button class="btn-accion btn-exportar" data-id="{{ periodo.id }}" title="Exportar">
              <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn-accion btn-eliminar" data-id="{{ periodo.id }}" title="Eliminar">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <i class="fas fa-calendar-times"></i>
          <h3>No hay períodos académicos</h3>
          <p>Crea el primer período académico para comenzar</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Pestaña de Carpetas -->
    <div id="carpetas-tab" class="tab-pane">
      <!-- Header de la sección -->
      <div class="section-header-clean">
        <div class="header-left">
          <h2 class="section-title">
            <i class="fas fa-folder-open"></i>
            Carpetas y Archivos
          </h2>
        </div>
        <div class="header-actions">
          <button class="btn-clean primary" onclick="mostrarModalCrearCarpeta()">
            <i class="fas fa-plus"></i>
            Nueva Carpeta
          </button>
          <button class="btn-clean secondary" onclick="mostrarModalSubirArchivo()">
                    <i class="fas fa-upload"></i>
                    Subir Archivo
                </button>
        </div>
      </div>

      <!-- Barra de herramientas minimalista -->
      <div class="toolbar-clean">
        <div class="search-container">
          <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Buscar carpetas..." id="searchFolders" class="search-input-clean">
          </div>
        </div>
        <div class="view-toggle">
          <button id="viewGridBtn" class="toggle-btn active" title="Vista de cuadrícula">
            <i class="fas fa-th-large"></i>
          </button>
          <button id="viewListBtn" class="toggle-btn" title="Vista de lista">
            <i class="fas fa-list"></i>
          </button>
        </div>
      </div>

      <!-- Vista de Cuadrícula Limpia -->
      <div id="grid-view" class="folders-grid-clean">
        {% for c in carpetas %}
        <div class="folder-card-clean" data-folder-id="{{ c.id }}" onclick="abrirCarpeta({{ c.id }})">
          <div class="folder-icon-container">
            <div class="folder-icon-clean">
              <i class="fas fa-folder"></i>
            </div>
            <div class="folder-menu-trigger" onclick="event.stopPropagation(); toggleFolderMenu({{ c.id }})">
              <i class="fas fa-ellipsis-h"></i>
            </div>
          </div>
          
          <div class="folder-info-clean">
            <h3 class="folder-name-clean">{{ c.nombre }}</h3>
            <p class="folder-desc-clean">{{ c.descripcion|truncatechars:50 }}</p>
          </div>
          
          <div class="folder-meta-clean">
            <div class="meta-item">
              <i class="fas fa-file-alt"></i>
              <span>{{ c.archivos.count }} archivo{{ c.archivos.count|pluralize }}</span>
            </div>
            <div class="meta-item">
              {% if c.publica %}
                <i class="fas fa-globe text-success"></i>
                <span>Pública</span>
              {% else %}
                <i class="fas fa-lock text-muted"></i>
                <span>Privada</span>
              {% endif %}
            </div>
          </div>

          <!-- Menu contextual -->
          <div class="folder-context-menu" id="menu-{{ c.id }}">
            <div class="menu-item" onclick="event.stopPropagation(); editarCarpeta({{ c.id }})">
              <i class="fas fa-edit"></i>
              <span>Editar</span>
            </div>
            <div class="menu-item" onclick="event.stopPropagation(); descargarCarpeta({{ c.id }}, '{{ c.nombre }}')">
              <i class="fas fa-download"></i>
              <span>Descargar carpeta</span>
            </div>
            <div class="menu-item danger" onclick="event.stopPropagation(); eliminarCarpeta({{ c.id }})">
              <i class="fas fa-trash"></i>
              <span>Eliminar</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Vista de Lista Limpia -->
      <div id="list-view" class="folders-list-clean" style="display: none;">
        <div class="list-header-clean">
          <div class="col-name">Nombre</div>
          <div class="col-files">Archivos</div>
          <div class="col-status">Estado</div>
          <div class="col-owner">Propietario</div>
          <div class="col-actions">Acciones</div>
        </div>
        
        {% for c in carpetas %}
        <div class="list-row-clean" onclick="abrirCarpeta({{ c.id }})">
          <div class="col-name">
            <div class="folder-name-row">
              <i class="fas fa-folder folder-icon-small"></i>
              <div class="name-info">
                <span class="name-text">{{ c.nombre }}</span>
                <span class="desc-text">{{ c.descripcion|truncatechars:40 }}</span>
              </div>
            </div>
          </div>
          
          <div class="col-files">
            <span class="files-count-text">{{ c.archivos.count }}</span>
          </div>
          
          <div class="col-status">
            {% if c.publica %}
              <span class="status-public">
                <i class="fas fa-globe"></i>
                Pública
              </span>
            {% else %}
              <span class="status-private">
                <i class="fas fa-lock"></i>
                Privada
              </span>
            {% endif %}
          </div>
          
          <div class="col-owner">
            <span class="owner-text">{{ c.usuario.username }}</span>
          </div>
          
          <div class="col-actions">
            <div class="actions-row" onclick="event.stopPropagation()">
              <button class="action-btn-clean" onclick="editarCarpeta({{ c.id }})" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn-clean" onclick="descargarCarpeta({{ c.id }}, '{{ c.nombre }}')" title="Descargar carpeta">
                <i class="fas fa-download"></i>
              </button>
              <button class="action-btn-clean danger" onclick="eliminarCarpeta({{ c.id }})" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Ventanas modales flotantes -->
  <div id="modalFondo" class="modal-fondo"></div>
  <div id="modalUsuario" class="modal-contenedor"></div>
  <div id="modalCarpeta" class="modal-contenedor"></div>
  <div id="modalArchivo" class="modal-contenedor"></div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Variables globales
const modalFondo = document.getElementById('modalFondo');
const modalUsuario = document.getElementById('modalUsuario');
const modalCarpeta = document.getElementById('modalCarpeta');
const modalArchivo = document.getElementById('modalArchivo');

// Funcionalidad de pestañas
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar pestañas
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.getAttribute('data-tab');
      
      // Remover clase active de todos los botones y paneles
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabPanes.forEach(pane => pane.classList.remove('active'));
      
      // Agregar clase active al botón y panel seleccionado
      button.classList.add('active');
      document.getElementById(targetTab + '-tab').classList.add('active');
    });
  });

  // Funcionalidad de vista de carpetas
  const viewGrid = document.getElementById('viewGrid');
  const viewList = document.getElementById('viewList');
  const gridView = document.getElementById('grid-view');
  const listView = document.getElementById('list-view');

  if (viewGrid && viewList && gridView && listView) {
    viewGrid.addEventListener('click', () => {
      viewGrid.classList.add('active');
      viewList.classList.remove('active');
      gridView.style.display = 'grid';
      listView.style.display = 'none';
    });

    viewList.addEventListener('click', () => {
      viewList.classList.add('active');
      viewGrid.classList.remove('active');
      gridView.style.display = 'none';
      listView.style.display = 'block';
    });
  }

  // Funcionalidad de búsqueda
  const searchUsuarios = document.getElementById('searchUsuarios');
  const searchCarpetas = document.getElementById('searchCarpetas');
  const searchFolders = document.getElementById('searchFolders');

  if (searchUsuarios) {
    searchUsuarios.addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#usuarios-tab tbody tr');
      
      rows.forEach(row => {
        const username = row.querySelector('td:first-child').textContent.toLowerCase();
        const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        
        if (username.includes(filter) || email.includes(filter)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }

  if (searchCarpetas) {
    searchCarpetas.addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      const folderCards = document.querySelectorAll('.folder-card');
      const folderListItems = document.querySelectorAll('.folder-list-item');
      
      folderCards.forEach(card => {
        const folderName = card.querySelector('h3').textContent.toLowerCase();
        const folderOwner = card.querySelector('.folder-owner').textContent.toLowerCase();
        
        if (folderName.includes(filter) || folderOwner.includes(filter)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });

      folderListItems.forEach(item => {
        const folderName = item.querySelector('h3').textContent.toLowerCase();
        const folderOwner = item.querySelector('p').textContent.toLowerCase();
        
        if (folderName.includes(filter) || folderOwner.includes(filter)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  }

  // Funcionalidad de búsqueda moderna
  if (searchFolders) {
    searchFolders.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const folderCards = document.querySelectorAll('.folder-card-modern, .folder-list-item-modern');
      
      folderCards.forEach(card => {
        const folderName = card.querySelector('.folder-title, h4')?.textContent.toLowerCase() || '';
        const folderDesc = card.querySelector('.folder-description, p')?.textContent.toLowerCase() || '';
        
        if (folderName.includes(searchTerm) || folderDesc.includes(searchTerm)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    });
  }
});

// Funciones de modal
function abrirModal(modal, url) {
  fetch(url)
  .then(res => res.text())
  .then(html => {
    modal.innerHTML = html;
    modal.style.display = 'block';
    modalFondo.style.display = 'block';

    const form = modal.querySelector('form');
    if(form) {
      form.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value},
          body: formData
        })
        .then(r => r.json())
        .then(data => {
          if(data.success){
            Swal.fire({
              icon: 'success',
              title: '¡Éxito!',
              text: 'Operación realizada correctamente',
              timer: 2000,
              showConfirmButton: false
            });
            cerrarModal();
            setTimeout(() => location.reload(), 2000);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Errores: ' + JSON.stringify(data.errors)
            });
          }
        });
      });
    }
  });
}

function cerrarModal() {
  modalUsuario.style.display = 'none';
  modalCarpeta.style.display = 'none';
  modalArchivo.style.display = 'none';
  modalFondo.style.display = 'none';
  modalUsuario.innerHTML = '';
  modalCarpeta.innerHTML = '';
  modalArchivo.innerHTML = '';
}

// Funciones de menú de carpetas
function toggleFolderMenu(folderId) {
  const menu = document.getElementById('menu-' + folderId);
  const allMenus = document.querySelectorAll('.folder-menu-dropdown');
  
  // Cerrar todos los otros menús
  allMenus.forEach(m => {
    if (m !== menu) {
      m.style.display = 'none';
    }
  });
  
  // Toggle del menú actual
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// Función para toggle del menú moderno
function toggleFolderMenuModern(folderId) {
  const menu = document.getElementById(`menu-modern-${folderId}`);
  const allMenus = document.querySelectorAll('.folder-dropdown-modern');
  
  // Cerrar todos los otros menús
  allMenus.forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });
  
  // Toggle del menú actual
  menu.classList.toggle('show');
}

// Cerrar menús al hacer click fuera
document.addEventListener('click', function(e) {
  if (!e.target.closest('.folder-menu')) {
    document.querySelectorAll('.folder-menu-dropdown').forEach(menu => {
      menu.style.display = 'none';
    });
  }
  
  if (!e.target.closest('.folder-menu-modern')) {
    document.querySelectorAll('.folder-dropdown-modern').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

// Funciones de gestión de carpetas
function editarCarpeta(id) {
  // Cargar datos de la carpeta en el modal Bootstrap
  fetch(`/editar_carpeta/${id}/`)
    .then(response => response.text())
    .then(html => {
      // Extraer los datos de la carpeta del HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const form = doc.querySelector('#editarCarpetaForm');
      
      if (form) {
        // Actualizar los campos del modal
        const modal = document.getElementById('editarCarpetaModal');
        const nombre = form.querySelector('#nombre').value;
        const descripcion = form.querySelector('#descripcion').value;
        const publica = form.querySelector('#publica').checked;
        
        modal.querySelector('#nombre').value = nombre;
        modal.querySelector('#descripcion').value = descripcion;
        modal.querySelector('#publica').checked = publica;
        modal.querySelector('#carpeta_id').value = id;
        
        // Mostrar el modal Bootstrap
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire('Error', 'No se pudo cargar la información de la carpeta', 'error');
    });
}

// Función para abrir carpeta y mostrar archivos
function abrirCarpeta(carpetaId) {
  // Guardar el ID de la carpeta actual
  window.carpetaActualId = carpetaId;
  
  // Mostrar estado de carga
  const modal = document.getElementById('archivosCarpetaModal');
  const estadoCarga = document.getElementById('estadoCarga');
  const estadoVacio = document.getElementById('estadoVacio');
  const listaArchivos = document.getElementById('listaArchivos');
  
  // Mostrar modal y estado de carga
  const bootstrapModal = new bootstrap.Modal(modal);
  bootstrapModal.show();
  
  estadoCarga.style.display = 'block';
  estadoVacio.style.display = 'none';
  listaArchivos.innerHTML = '';
  
  // Obtener información de la carpeta y sus archivos
  fetch(`/obtener_archivos_carpeta/${carpetaId}/`)
    .then(response => response.json())
    .then(data => {
      estadoCarga.style.display = 'none';
      
      if (data.success) {
        mostrarArchivosEnModal(data.carpeta, data.archivos);
      } else {
        Swal.fire('Error', data.error || 'No se pudo cargar la información de la carpeta', 'error');
        bootstrapModal.hide();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      estadoCarga.style.display = 'none';
      Swal.fire('Error', 'Error en la conexión', 'error');
      bootstrapModal.hide();
    });
}

// Función para mostrar archivos en el modal Bootstrap
function mostrarArchivosEnModal(carpeta, archivos) {
  // Actualizar información de la carpeta
  document.getElementById('nombreCarpetaModal').textContent = carpeta.nombre;
  document.getElementById('descripcionCarpetaModal').textContent = carpeta.descripcion || 'Sin descripción';
  document.getElementById('totalArchivosModal').textContent = carpeta.total_archivos;
  
  const estadoCarpeta = document.getElementById('estadoCarpetaModal');
  estadoCarpeta.className = `badge ${carpeta.publica ? 'bg-success' : 'bg-secondary'}`;
  estadoCarpeta.innerHTML = `<i class="fas ${carpeta.publica ? 'fa-globe' : 'fa-lock'} me-1"></i>${carpeta.publica ? 'Pública' : 'Privada'}`;
  
  const listaArchivos = document.getElementById('listaArchivos');
  const estadoVacio = document.getElementById('estadoVacio');
  
  if (archivos.length === 0) {
    listaArchivos.innerHTML = '';
    estadoVacio.style.display = 'block';
  } else {
    estadoVacio.style.display = 'none';
    
    const archivosHtml = archivos.map(archivo => `
      <div class="archivo-item d-flex justify-content-between align-items-center p-3 mb-2 border rounded">
        <div class="d-flex align-items-center">
          <div class="archivo-icon me-3">
            <i class="fas ${getFileIcon(archivo.nombre)} fa-2x"></i>
          </div>
          <div class="archivo-details">
            <h6 class="mb-1">${archivo.nombre}</h6>
            <small class="text-muted">
              <i class="fas fa-calendar me-1"></i>${archivo.fecha_subida}
              <i class="fas fa-hdd ms-3 me-1"></i>${archivo.tamaño}
              <i class="fas fa-user ms-3 me-1"></i>${archivo.usuario}
            </small>
          </div>
        </div>
        <div class="archivo-actions">
          <button class="btn btn-outline-primary btn-sm me-1" onclick="descargarArchivo(${archivo.id})" title="Descargar">
            <i class="fas fa-download"></i>
          </button>
          <button class="btn btn-outline-warning btn-sm me-1" onclick="editarArchivo(${archivo.id})" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-outline-danger btn-sm" onclick="eliminarArchivoModal(${archivo.id})" title="Eliminar">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
    
    listaArchivos.innerHTML = archivosHtml;
  }
}

// Función para obtener el icono según el tipo de archivo
function getFileIcon(nombreArchivo) {
  const extension = nombreArchivo.split('.').pop().toLowerCase();
  const iconMap = {
    'pdf': 'fa-file-pdf text-danger',
    'doc': 'fa-file-word text-primary',
    'docx': 'fa-file-word text-primary',
    'xls': 'fa-file-excel text-success',
    'xlsx': 'fa-file-excel text-success',
    'ppt': 'fa-file-powerpoint text-warning',
    'pptx': 'fa-file-powerpoint text-warning',
    'jpg': 'fa-file-image text-info',
    'jpeg': 'fa-file-image text-info',
    'png': 'fa-file-image text-info',
    'gif': 'fa-file-image text-info',
    'mp4': 'fa-file-video text-purple',
    'avi': 'fa-file-video text-purple',
    'mp3': 'fa-file-audio text-orange',
    'wav': 'fa-file-audio text-orange',
    'zip': 'fa-file-archive text-secondary',
    'rar': 'fa-file-archive text-secondary',
    'txt': 'fa-file-alt text-muted'
  };
  return iconMap[extension] || 'fa-file text-muted';
}

// Funciones para acciones de archivos
function descargarArchivo(archivoId) {
  window.open(`/descargar_archivo/${archivoId}/`, '_blank');
}

function editarArchivo(archivoId) {
  Swal.close(); // Cerrar el modal actual
  // Cargar el modal de edición de archivo
  fetch(`/editar_archivo/${archivoId}/`)
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const form = doc.querySelector('#editarArchivoForm');
      
      if (form) {
        const modal = document.getElementById('editarArchivoModal');
        const nombre = form.querySelector('#nombre').value;
        
        modal.querySelector('#nombre').value = nombre;
        modal.querySelector('#archivo_id').value = archivoId;
        
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire('Error', 'No se pudo cargar la información del archivo', 'error');
    });
}

function eliminarArchivoModal(archivoId) {
  Swal.fire({
    title: '¿Eliminar archivo?',
    text: "Esta acción no se puede deshacer",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#dc3545'
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/eliminar_archivo/${archivoId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Archivo eliminado',
            timer: 2000,
            showConfirmButton: false
          });
          setTimeout(() => location.reload(), 2000);
        } else {
          Swal.fire('Error', 'No se pudo eliminar el archivo', 'error');
        }
      });
    }
  });
}

function subirArchivoACarpeta(carpetaId) {
  // Si se llama desde el modal de archivos, usar la carpeta actual
  if (!carpetaId && window.carpetaActualId) {
    carpetaId = window.carpetaActualId;
  }
  
  // Cerrar el modal actual si está abierto
  const modalActual = bootstrap.Modal.getInstance(document.getElementById('archivosCarpetaModal'));
  if (modalActual) {
    modalActual.hide();
  }
  
  // Mostrar modal de subir archivo con la carpeta preseleccionada
  const modal = document.getElementById('subirArchivoModal');
  if (modal) {
    // Preseleccionar la carpeta
    const selectCarpeta = modal.querySelector('#carpeta');
    if (selectCarpeta && carpetaId) {
      selectCarpeta.value = carpetaId;
    }
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
  }
}

// Función para duplicar carpeta (nueva funcionalidad)
function duplicarCarpeta(carpetaId) {
  Swal.fire({
    title: '¿Duplicar carpeta?',
    text: 'Se creará una copia de esta carpeta con todos sus archivos',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Sí, duplicar',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#3b82f6'
  }).then((result) => {
    if (result.isConfirmed) {
      // Implementar lógica de duplicación
      fetch(`/duplicar_carpeta/${carpetaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('¡Duplicada!', 'La carpeta ha sido duplicada exitosamente', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          Swal.fire('Error', data.error || 'No se pudo duplicar la carpeta', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error en la conexión', 'error');
      });
    }
  });
}

function eliminarCarpeta(id) {
  Swal.fire({
    title: '¿Eliminar carpeta?',
    text: "Esta acción no se puede deshacer",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(result => {
    if(result.isConfirmed){
      fetch(`/eliminar_carpeta/${id}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
      })
      .then(r => r.json())
      .then(data => {
        if(data.success){
          Swal.fire({
            icon: 'success',
            title: 'Carpeta eliminada',
            timer: 2000,
            showConfirmButton: false
          });
          setTimeout(() => location.reload(), 2000);
        } else {
          Swal.fire('Error', 'No se pudo eliminar la carpeta', 'error');
        }
      });
    }
  });
}

// Event listeners para botones
document.addEventListener('DOMContentLoaded', function() {
  // Crear usuario
  const btnCrearUsuario = document.getElementById('btnCrearUsuario');
  if (btnCrearUsuario) {
    btnCrearUsuario.onclick = () => {
      const modal = new bootstrap.Modal(document.getElementById('crearUsuarioModal'));
      modal.show();
    };
  }

  // Crear período
  const btnCrearPeriodo = document.getElementById('btnCrearPeriodo');
  if (btnCrearPeriodo) {
    btnCrearPeriodo.onclick = () => {
            // Usar el modal Bootstrap en lugar del modal personalizado
            const modal = new bootstrap.Modal(document.getElementById('crearPeriodoModal'));
            modal.show();
        };
  }

  // Activar período
  document.querySelectorAll('.btn-activar').forEach(btn => {
    btn.onclick = () => {
      Swal.fire({
        title: '¿Activar período?',
        text: "Esto desactivará el período actual",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, activar',
        cancelButtonText: 'Cancelar'
      }).then(result => {
        if(result.isConfirmed){
          fetch(`/activar_periodo/${btn.dataset.id}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
          })
          .then(r => r.json())
          .then(data => {
            if(data.success){
              Swal.fire({
                icon: 'success',
                title: 'Período activado',
                timer: 2000,
                showConfirmButton: false
              });
              setTimeout(() => location.reload(), 2000);
            } else {
              Swal.fire('Error', 'No se pudo activar el período', 'error');
            }
          });
        }
      });
    }
  });

  // Exportar período
  document.querySelectorAll('.btn-exportar').forEach(btn => {
    btn.onclick = () => {
      const periodoId = btn.dataset.id;
      
      // Mostrar opciones de exportación con SweetAlert
      Swal.fire({
        title: 'Opciones de Exportación',
        html: `
          <div class="text-center">
            <p class="mb-4">Selecciona cómo deseas exportar el período académico:</p>
            <div class="d-grid gap-3">
              <button class="btn btn-primary btn-lg" onclick="exportarLocal(${periodoId})">
                <i class="fas fa-download me-2"></i>
                Descargar ZIP Local
              </button>
              <button class="btn btn-success btn-lg" onclick="exportarGoogleDrive(${periodoId})">
                <i class="fab fa-google-drive me-2"></i>
                Abrir Google Drive
              </button>
            </div>
          </div>
        `,
        showConfirmButton: false,
        showCancelButton: true,
        cancelButtonText: 'Cancelar',
        width: '500px'
      });
    }
  });

  // Editar usuario
  document.querySelectorAll('.btn-editar').forEach(btn => {
    btn.onclick = () => {
      // Cargar datos del usuario en el modal
      const userId = btn.dataset.id;
      fetch(`/editar_usuario/${userId}/`)
        .then(response => response.text())
        .then(html => {
          // Extraer los datos del usuario del HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const form = doc.querySelector('#editarUsuarioForm');
          
          if (form) {
            // Actualizar los campos del modal
            const modal = document.getElementById('editarUsuarioModal');
            const username = form.querySelector('#username').value;
            const email = form.querySelector('#email').value;
            const isAdmin = form.querySelector('#is_admin').checked;
            
            modal.querySelector('#username').value = username;
            modal.querySelector('#email').value = email;
            modal.querySelector('#is_admin').checked = isAdmin;
            modal.querySelector('#user_id').value = userId;
            
            // Mostrar el modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'No se pudo cargar la información del usuario', 'error');
        });
    };
  });

  // Eliminar usuario
  document.querySelectorAll('.btn-eliminar').forEach(btn => {
    // Verificar si el botón está en la sección de usuarios
    const isUserButton = btn.closest('#usuarios-tab');
    if (isUserButton) {
      btn.onclick = () => {
        Swal.fire({
          title: '¿Estás seguro?',
          text: "Esta acción eliminará al usuario",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then(result => {
          if(result.isConfirmed){
            fetch(`/eliminar_usuario/${btn.dataset.id}/`, {
              method: 'POST',
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
            })
            .then(r => r.json())
            .then(data => {
              if(data.success){
                Swal.fire({
                  icon: 'success',
                  title: 'Usuario eliminado',
                  timer: 2000,
                  showConfirmButton: false
                });
                setTimeout(() => location.reload(), 2000);
              } else {
                Swal.fire('Error', 'No se pudo eliminar el usuario', 'error');
              }
            });
          }
        });
      }
    }
    
    // Verificar si el botón está en la sección de períodos
    const isPeriodButton = btn.closest('#periodos-tab');
    if (isPeriodButton) {
      btn.onclick = () => {
        Swal.fire({
          title: '¿Eliminar período académico?',
          text: "Esta acción eliminará el período y todas sus carpetas asociadas",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then(result => {
          if(result.isConfirmed){
            fetch(`/eliminar_periodo/${btn.dataset.id}/`, {
              method: 'POST',
              headers: {'X-CSRFToken': '{{ csrf_token }}'},
            })
            .then(r => r.json())
            .then(data => {
              if(data.success){
                Swal.fire({
                  icon: 'success',
                  title: 'Período eliminado',
                  timer: 2000,
                  showConfirmButton: false
                });
                setTimeout(() => location.reload(), 2000);
              } else {
                Swal.fire('Error', 'No se pudo eliminar el período', 'error');
              }
            });
          }
        });
      }
    }
  });

  // Crear carpeta
  const btnCrearCarpeta = document.getElementById('btnCrearCarpeta');
  if (btnCrearCarpeta) {
    btnCrearCarpeta.onclick = () => {
      const modal = new bootstrap.Modal(document.getElementById('crearCarpetaModal'));
      modal.show();
    };
  }

  // Editar carpeta
  document.querySelectorAll('.btn-editar-carpeta').forEach(btn => {
    btn.onclick = () => {
      // Cargar datos de la carpeta en el modal
      const carpetaId = btn.dataset.id;
      fetch(`/editar_carpeta/${carpetaId}/`)
        .then(response => response.text())
        .then(html => {
          // Extraer los datos de la carpeta del HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const form = doc.querySelector('#editarCarpetaForm');
          
          if (form) {
            // Actualizar los campos del modal
            const modal = document.getElementById('editarCarpetaModal');
            const nombre = form.querySelector('#nombre').value;
            const descripcion = form.querySelector('#descripcion').value;
            const publica = form.querySelector('#publica').checked;
            
            modal.querySelector('#nombre').value = nombre;
            modal.querySelector('#descripcion').value = descripcion;
            modal.querySelector('#publica').checked = publica;
            modal.querySelector('#carpeta_id').value = carpetaId;
            
            // Mostrar el modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire('Error', 'No se pudo cargar la información de la carpeta', 'error');
        });
    };
  });

  // Eliminar carpeta
  document.querySelectorAll('.btn-eliminar-carpeta').forEach(btn => {
    btn.onclick = () => {
      Swal.fire({
        title: '¿Eliminar carpeta?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then(result => {
        if(result.isConfirmed){
          fetch(`/eliminar_carpeta/${btn.dataset.id}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
          })
          .then(r => r.json())
          .then(data => {
            if(data.success){
              Swal.fire({
                icon: 'success',
                title: 'Carpeta eliminada',
                timer: 2000,
                showConfirmButton: false
              });
              setTimeout(() => location.reload(), 2000);
            } else {
              Swal.fire('Error', 'No se pudo eliminar la carpeta', 'error');
            }
          });
        }
      });
    }
  });
});

function eliminarArchivoAdmin(id) {
  Swal.fire({
    title: '¿Eliminar archivo?',
    text: "Esta acción no se puede deshacer",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(result => {
    if(result.isConfirmed){
      const formData = new FormData();
      formData.append('archivo_id', id);

      fetch(`/eliminar_archivo/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Archivo eliminado',
            timer: 2000,
            showConfirmButton: false
          });
          setTimeout(() => location.reload(), 2000);
        } else {
          Swal.fire('Error', 'No se pudo eliminar el archivo', 'error');
        }
      })
      .catch(() => Swal.fire('Error', 'Error en la solicitud', 'error'));
    }
  });
}

// Funciones de exportación
function exportarLocal(periodoId) {
  Swal.close(); // Cerrar el modal de opciones
  
  // Mostrar mensaje de preparación
  Swal.fire({
    title: 'Preparando descarga...',
    text: 'Se está generando el archivo ZIP',
    icon: 'info',
    allowOutsideClick: false,
    showConfirmButton: false,
    timer: 2000
  });
  
  // Iniciar descarga
  setTimeout(() => {
    window.open(`/exportar_periodo_zip/${periodoId}/`, '_blank');
    Swal.fire({
      icon: 'success',
      title: 'Descarga iniciada',
      text: 'El archivo se está descargando...',
      timer: 3000,
      showConfirmButton: false
    });
  }, 2000);
}

function exportarGoogleDrive(periodoId) {
  Swal.close(); // Cerrar el modal de opciones
  
  // Mostrar información sobre Google Drive
  Swal.fire({
    title: 'Abrir Google Drive',
    html: `
      <div class="text-center">
        <i class="fab fa-google-drive text-success mb-3" style="font-size: 4rem;"></i>
        <p class="mb-3">Se abrirá Google Drive en una nueva pestaña.</p>
        <p class="text-muted small">
          Puedes crear una carpeta para el período académico y subir los archivos manualmente.
        </p>
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Abrir Google Drive',
    cancelButtonText: 'Cancelar',
    confirmButtonColor: '#28a745'
  }).then((result) => {
    if (result.isConfirmed) {
      // Abrir Google Drive en nueva pestaña
      window.open('https://drive.google.com/drive/my-drive', '_blank');
      
      // Mostrar mensaje adicional
      Swal.fire({
        icon: 'info',
        title: 'Google Drive abierto',
        html: `
          <p>Google Drive se ha abierto en una nueva pestaña.</p>
          <p class="text-muted small">
            Puedes crear una carpeta y subir los archivos del período académico.
            <br><br>
            <strong>Tip:</strong> También puedes usar la opción "Descargar ZIP Local" 
            y luego subir el archivo a Google Drive.
          </p>
        `,
        confirmButtonText: 'Entendido'
      });
    }
  });
}

// Modal global para subir archivos
function mostrarModalSubirArchivoGlobal() {
  // Primero obtener las carpetas disponibles
  fetch('/api/carpetas/', {
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      mostrarModalSubirGlobal(data.carpetas);
    } else {
      Swal.fire('Error', 'No se pudieron cargar las carpetas', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    Swal.fire('Error', 'Error en la conexión', 'error');
  });
}

function mostrarModalSubirGlobal(carpetas) {
  const carpetasOptions = carpetas.map(c => 
    `<option value="${c.id}">${c.nombre}</option>`
  ).join('');

  const modalHtml = `
    <div class="modal-subir-global">
      <div class="modal-header-global">
        <h3><i class="fas fa-cloud-upload-alt"></i> Subir Archivo</h3>
        <button type="button" class="btn-cerrar-global" onclick="cerrarModalSubirGlobal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body-global">
        <div class="form-group">
          <label for="selectCarpeta">Seleccionar carpeta de destino:</label>
          <select id="selectCarpeta" class="form-select" onchange="validarFormularioGlobal()">
            <option value="">Selecciona una carpeta...</option>
            ${carpetasOptions}
          </select>
        </div>
        <div class="upload-area-global" onclick="document.getElementById('fileInputGlobal').click()">
          <i class="fas fa-cloud-upload-alt upload-icon-global"></i>
          <p class="upload-text-global">Haz clic aquí para seleccionar un archivo</p>
          <p class="upload-subtext-global">o arrastra y suelta el archivo aquí</p>
        </div>
        <input type="file" id="fileInputGlobal" style="display: none;" onchange="mostrarArchivoSeleccionadoGlobal(this)">
        <div class="upload-file-info-global" id="fileInfoGlobal" style="display: none;">
          <div class="file-preview-global">
            <i class="fas fa-file-alt"></i>
            <span id="fileNameGlobal"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer-global">
        <button class="btn-cancelar-global" onclick="cerrarModalSubirGlobal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn-subir-global" onclick="subirArchivoGlobal()" disabled>
          <i class="fas fa-upload"></i> Subir archivo
        </button>
      </div>
    </div>
  `;

  modalArchivo.innerHTML = modalHtml;
  modalArchivo.style.display = 'block';
  modalFondo.style.display = 'block';
}

function validarFormularioGlobal() {
  const fileInput = document.getElementById('fileInputGlobal');
  const selectCarpeta = document.getElementById('selectCarpeta');
  const submitBtn = document.querySelector('.btn-subir-global');
  
  // Habilitar botón solo si hay archivo y carpeta seleccionada
  if (fileInput && fileInput.files && fileInput.files[0] && selectCarpeta && selectCarpeta.value) {
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
  }
}

function mostrarArchivoSeleccionadoGlobal(input) {
  const fileInfo = document.getElementById('fileInfoGlobal');
  const fileName = document.getElementById('fileNameGlobal');
  
  if (input.files && input.files[0]) {
    fileName.textContent = input.files[0].name;
    fileInfo.style.display = 'block';
    
    // Validar formulario completo
    validarFormularioGlobal();
  }
}

function subirArchivoGlobal() {
  const fileInput = document.getElementById('fileInputGlobal');
  const selectCarpeta = document.getElementById('selectCarpeta');
  const submitBtn = document.querySelector('.btn-subir-global');
  
  if (!fileInput.files || !fileInput.files[0]) {
    Swal.fire('Error', 'Por favor selecciona un archivo', 'error');
    return;
  }
  
  if (!selectCarpeta.value) {
    Swal.fire('Error', 'Por favor selecciona una carpeta', 'error');
    return;
  }

  // Mostrar loading
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
  submitBtn.disabled = true;

  const formData = new FormData();
  formData.append('archivo', fileInput.files[0]);
  formData.append('carpeta', selectCarpeta.value);

  fetch(`/subir_archivo/${selectCarpeta.value}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Archivo subido exitosamente',
        timer: 2000,
        showConfirmButton: false
      });
      cerrarModalSubirGlobal();
      setTimeout(() => location.reload(), 2000);
    } else {
      Swal.fire('Error', data.error || 'No se pudo subir el archivo', 'error');
      submitBtn.innerHTML = '<i class="fas fa-upload"></i> Subir archivo';
      submitBtn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    Swal.fire('Error', 'Error en la conexión', 'error');
    submitBtn.innerHTML = '<i class="fas fa-upload"></i> Subir archivo';
    submitBtn.disabled = false;
  });
}

function cerrarModalSubirGlobal() {
  modalArchivo.style.display = 'none';
  modalFondo.style.display = 'none';
  modalArchivo.innerHTML = '';
}

// Función para subir archivo a una carpeta desde el dashboard del administrador
function subirArchivoACarpetaAdmin(carpetaId, carpetaNombre) {
  mostrarModalSubirArchivoAdmin(carpetaId, carpetaNombre);
}

// Modal personalizado para subir archivos desde el dashboard del administrador
function mostrarModalSubirArchivoAdmin(carpetaId, carpetaNombre) {
  const modalHtml = `
    <div class="modal-subir-archivo-admin">
      <div class="modal-header-admin">
        <h3><i class="fas fa-cloud-upload-alt"></i> Subir archivo a "${carpetaNombre}"</h3>
        <button type="button" class="btn-cerrar-admin" onclick="cerrarModalSubirAdmin()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body-admin">
        <div class="upload-area-admin" onclick="document.getElementById('fileInputAdmin').click()">
          <i class="fas fa-cloud-upload-alt upload-icon-admin"></i>
          <p class="upload-text-admin">Haz clic aquí para seleccionar un archivo</p>
          <p class="upload-subtext-admin">o arrastra y suelta el archivo aquí</p>
        </div>
        <input type="file" id="fileInputAdmin" style="display: none;" onchange="mostrarArchivoSeleccionadoAdmin(this)">
        <div class="upload-file-info-admin" id="fileInfoAdmin" style="display: none;">
          <div class="file-preview-admin">
            <i class="fas fa-file-alt"></i>
            <span id="fileNameAdmin"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer-admin">
        <button class="btn-cancelar-admin" onclick="cerrarModalSubirAdmin()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn-subir-admin" onclick="subirArchivoSeleccionadoAdmin()" disabled>
          <i class="fas fa-upload"></i> Subir archivo
        </button>
      </div>
    </div>
  `;

  modalArchivo.innerHTML = modalHtml;
  modalArchivo.style.display = 'block';
  modalFondo.style.display = 'block';
  
  // Guardar el ID de la carpeta destino
  window.carpetaDestinoAdmin = carpetaId;
}

function mostrarArchivoSeleccionadoAdmin(input) {
  const fileInfo = document.getElementById('fileInfoAdmin');
  const fileName = document.getElementById('fileNameAdmin');
  const submitBtn = document.querySelector('.btn-subir-admin');
  
  if (input.files && input.files[0]) {
    fileName.textContent = input.files[0].name;
    fileInfo.style.display = 'block';
    submitBtn.disabled = false;
  }
}

function subirArchivoSeleccionadoAdmin() {
  const fileInput = document.getElementById('fileInputAdmin');
  const submitBtn = document.querySelector('.btn-subir-admin');
  
  if (!fileInput.files || !fileInput.files[0]) {
    Swal.fire('Error', 'Por favor selecciona un archivo', 'error');
    return;
  }

  // Mostrar loading
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
  submitBtn.disabled = true;

  const formData = new FormData();
  formData.append('archivo', fileInput.files[0]);
  formData.append('carpeta', window.carpetaDestinoAdmin);

  fetch(`/subir_archivo/${window.carpetaDestinoAdmin}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Archivo subido exitosamente',
        timer: 2000,
        showConfirmButton: false
      });
      cerrarModalSubirAdmin();
      setTimeout(() => location.reload(), 2000);
    } else {
      Swal.fire('Error', data.error || 'No se pudo subir el archivo', 'error');
      submitBtn.innerHTML = '<i class="fas fa-upload"></i> Subir archivo';
      submitBtn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    Swal.fire('Error', 'Error en la conexión', 'error');
    submitBtn.innerHTML = '<i class="fas fa-upload"></i> Subir archivo';
    submitBtn.disabled = false;
  });
}

function cerrarModalSubirAdmin() {
  modalArchivo.style.display = 'none';
  modalFondo.style.display = 'none';
  modalArchivo.innerHTML = '';
}

// Función para descargar carpetas
function descargarCarpeta(carpetaId, carpetaNombre) {
  Swal.fire({
    title: '¿Descargar carpeta?',
    text: `¿Estás seguro de que quieres descargar la carpeta "${carpetaNombre}"?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3b82f6',
    cancelButtonColor: '#6b7280',
    confirmButtonText: 'Sí, descargar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      // Mostrar loading
      Swal.fire({
        title: 'Preparando descarga...',
        text: 'Por favor espera mientras se prepara el archivo ZIP',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Crear enlace de descarga
      const downloadUrl = `/descargar_carpeta/${carpetaId}/`;
      
      fetch(downloadUrl, {
        method: 'GET',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => {
        if (response.ok) {
          return response.blob();
        } else {
          throw new Error('Error al descargar la carpeta');
        }
      })
      .then(blob => {
        // Crear enlace de descarga
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `${carpetaNombre}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        Swal.fire({
          icon: 'success',
          title: 'Descarga iniciada',
          text: `La carpeta "${carpetaNombre}" se está descargando`,
          timer: 3000,
          showConfirmButton: false
        });
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error en la descarga',
          text: 'No se pudo descargar la carpeta. Inténtalo de nuevo.'
        });
      });
    }
  });
}

// Funcionalidad de vista de carpetas limpia
document.addEventListener('DOMContentLoaded', function() {
  const viewGridBtn = document.getElementById('viewGridBtn');
  const viewListBtn = document.getElementById('viewListBtn');
  const gridView = document.getElementById('grid-view');
  const listView = document.getElementById('list-view');
  const searchFolders = document.getElementById('searchFolders');

  // Toggle entre vista de cuadrícula y lista
  if (viewGridBtn && viewListBtn && gridView && listView) {
    viewGridBtn.addEventListener('click', function() {
      gridView.style.display = 'grid';
      listView.style.display = 'none';
      viewGridBtn.classList.add('active');
      viewListBtn.classList.remove('active');
    });

    viewListBtn.addEventListener('click', function() {
      gridView.style.display = 'none';
      listView.style.display = 'block';
      viewGridBtn.classList.remove('active');
      viewListBtn.classList.add('active');
    });
  }

  // Funcionalidad de búsqueda limpia
  if (searchFolders) {
    searchFolders.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const folderCards = document.querySelectorAll('.folder-card-clean, .list-row-clean');
      
      folderCards.forEach(card => {
        const folderName = card.querySelector('.folder-name-clean, .name-text')?.textContent.toLowerCase() || '';
        const folderDesc = card.querySelector('.folder-desc-clean, .desc-text')?.textContent.toLowerCase() || '';
        
        if (folderName.includes(searchTerm) || folderDesc.includes(searchTerm)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    });
  }
});

// Funciones de menú contextual limpio
function toggleFolderMenu(folderId) {
  const menu = document.getElementById('menu-' + folderId);
  const allMenus = document.querySelectorAll('.folder-context-menu');
  
  // Cerrar todos los otros menús
  allMenus.forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });
  
  // Toggle del menú actual
  menu.classList.toggle('show');
}

// Cerrar menús al hacer click fuera
document.addEventListener('click', function(e) {
  if (!e.target.closest('.folder-menu-trigger') && !e.target.closest('.folder-context-menu')) {
    document.querySelectorAll('.folder-context-menu').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

// Función para mostrar modal de crear carpeta
function mostrarModalCrearCarpeta() {
  const modal = new bootstrap.Modal(document.getElementById('crearCarpetaModal'));
  modal.show();
}

// Función para mostrar modal de subir archivo Bootstrap
function mostrarModalSubirArchivo() {
  // Primero cargar las carpetas disponibles
  fetch('/api/carpetas/')
    .then(response => response.json())
    .then(data => {
      if (data.carpetas) {
        // Actualizar el select de carpetas en el modal
        const selectCarpeta = document.querySelector('#subirArchivoModal select[name="carpeta_destino"]');
        if (selectCarpeta) {
          selectCarpeta.innerHTML = '<option value="">Seleccionar carpeta...</option>';
          data.carpetas.forEach(carpeta => {
            const option = document.createElement('option');
            option.value = carpeta.id;
            option.textContent = carpeta.nombre;
            selectCarpeta.appendChild(option);
          });
        }
      }
      
      // Mostrar el modal
      const modal = new bootstrap.Modal(document.getElementById('subirArchivoModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error al cargar carpetas:', error);
      // Mostrar el modal aunque falle la carga de carpetas
      const modal = new bootstrap.Modal(document.getElementById('subirArchivoModal'));
      modal.show();
    });
}

// Función para editar archivo
function editarArchivo(id) {
  fetch(`/editar_archivo/${id}/`)
    .then(response => response.text())
    .then(html => {
      // Remover modal existente si existe
      const existingModal = document.querySelector('#editarArchivoModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Agregar el nuevo modal al body
      document.body.insertAdjacentHTML('beforeend', html);
      
      // Mostrar el modal usando Bootstrap
      const modalElement = document.querySelector('#editarArchivoModal');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
      
      // Manejar el envío del formulario
      const form = modalElement.querySelector('#editarArchivoForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const formData = new FormData(form);
          
          fetch(`/editar_archivo/${id}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: 'Archivo editado correctamente',
                timer: 2000,
                showConfirmButton: false
              });
              modal.hide();
              setTimeout(() => location.reload(), 2000);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'No se pudo editar el archivo'
              });
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Error en la conexión'
            });
          });
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo cargar el formulario de edición'
      });
    });
}

</script>

<!-- Incluir modales Bootstrap -->
{% include 'modals/crear_periodo.html' %}
{% include 'modals/subir_archivo.html' %}
{% include 'modals/crear_usuario.html' %}
{% include 'modals/editar_usuario.html' %}
{% include 'modals/crear_carpeta.html' %}
{% include 'modals/editar_carpeta.html' %}
{% include 'modals/editar_archivo.html' %}

<!-- Modal para mostrar archivos de carpeta -->
<div class="modal fade" id="archivosCarpetaModal" tabindex="-1" aria-labelledby="archivosCarpetaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="archivosCarpetaModalLabel">
          <i class="fas fa-folder-open me-2"></i>
          <span id="nombreCarpetaModal">Archivos de la carpeta</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Información de la carpeta -->
        <div class="carpeta-info mb-4">
          <div class="row">
            <div class="col-md-8">
              <h6 class="text-muted mb-1">Descripción</h6>
              <p id="descripcionCarpetaModal" class="mb-2">-</p>
            </div>
            <div class="col-md-4 text-end">
              <div class="carpeta-stats">
                <span class="badge bg-primary me-2">
                  <i class="fas fa-file me-1"></i>
                  <span id="totalArchivosModal">0</span> archivos
                </span>
                <span class="badge" id="estadoCarpetaModal">
                  <i class="fas fa-globe me-1"></i>
                  Pública
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Botón para subir archivos -->
        <div class="mb-3">
          <button type="button" class="btn btn-success" onclick="subirArchivoACarpeta()">
            <i class="fas fa-upload me-2"></i>
            Subir archivo
          </button>
        </div>

        <!-- Lista de archivos -->
        <div id="listaArchivos">
          <!-- Los archivos se cargarán aquí dinámicamente -->
        </div>

        <!-- Estado vacío -->
        <div id="estadoVacio" class="text-center py-5" style="display: none;">
          <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Esta carpeta está vacía</h5>
          <p class="text-muted">Sube archivos para comenzar</p>
        </div>

        <!-- Estado de carga -->
        <div id="estadoCarga" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="text-muted mt-2">Cargando archivos...</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
