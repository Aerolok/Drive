{% extends 'layout.html' %}

{% block content %}
<div class="admin-panel">

  <h1 class="titulo-principal">Bienvenido, Usuario {{ request.user.username }}</h1>

  <hr class="linea-turquesa">

  <section class="carpetas-section">
    <div class="section-header">
      <h2 class="titulo-seccion">Mis Carpetas</h2>
      <!-- Botón Crear Carpeta eliminado -->
      <!-- <button id="btnCrearCarpeta" class="btn">Agregar Carpeta</button> -->
    </div>

    <table class="tabla-estilo">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in carpetas %}
        <tr>
          <td>{{ c.nombre }}</td>
          <td>{{ c.descripcion }}</td>
          <td>
            <button type="button" class="btn btn-subir-archivo" data-id="{{ c.id }}">Subir Archivo</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3">No tienes carpetas.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <hr class="linea-turquesa">

  <section class="archivos-section">
    <h2 class="titulo-seccion">Mis Archivos</h2>
    <table class="tabla-estilo">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Carpeta</th>
          <th>Fecha</th>
          <th>Descargar</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for archivo in archivos %}
        <tr>
          <td>{{ archivo.nombre }}</td>
          <td>{{ archivo.carpeta.nombre }}</td>
          <td>{{ archivo.fecha_subida|date:"Y-m-d H:i" }}</td>
          <td><a href="{{ archivo.archivo.url }}" target="_blank" class="link-archivo">Ver</a></td>
          <td>
            <button class="btn" onclick="editarArchivo({{ archivo.id }}); event.preventDefault();">Editar</button>
            <button class="btn" onclick="eliminarArchivo({{ archivo.id }}); event.preventDefault();">Eliminar</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">No tienes archivos.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

</div>

<!-- Modal personalizado -->
<div id="modalFondo" class="modal-fondo" style="display: none;"></div>
<div id="modalCarpeta" class="modal-carpeta" style="display: none;"></div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const modalFondo = document.getElementById('modalFondo');
  const modalCarpeta = document.getElementById('modalCarpeta');

  function abrirModal(url) {
    fetch(url)
      .then(res => res.text())
      .then(html => {
        modalCarpeta.innerHTML = html;
        modalCarpeta.style.display = 'block';
        modalFondo.style.display = 'block';

        const form = modalCarpeta.querySelector('form');
        if (form) {
          form.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(url, {
              method: 'POST',
              headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: formData
            })
            .then(r => r.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: '¡Éxito!',
                  text: 'Operación exitosa',
                  timer: 2000,
                  showConfirmButton: false
                });
                cerrarModal();
                setTimeout(() => location.reload(), 2000);
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error de validación',
                  html: '<pre>' + JSON.stringify(data.errors, null, 2) + '</pre>'
                });
              }
            });
          });
        }
      });
  }

  function cerrarModal() {
    modalCarpeta.style.display = 'none';
    modalFondo.style.display = 'none';
    modalCarpeta.innerHTML = '';
  }

  // Crear carpeta (solo si el botón existe)
  const btnCrearCarpeta = document.getElementById('btnCrearCarpeta');
  if (btnCrearCarpeta) {
    btnCrearCarpeta.onclick = () => abrirModal("{% url 'crear_carpeta' %}");
  }

  // Subir archivo
  document.querySelectorAll('.btn-subir-archivo').forEach(btn => {
    btn.onclick = () => abrirModal(`/subir_archivo/${btn.dataset.id}/`);
  });

  // Editar archivo
  function editarArchivo(id) {
    abrirModal(`/editar_archivo/${id}/`);
  }

  // Eliminar archivo
  function eliminarArchivo(id) {
    Swal.fire({
      title: '¿Estás seguro?',
      text: "Esta acción eliminará el archivo",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/eliminar_archivo/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Eliminado',
              text: 'Archivo eliminado correctamente',
              timer: 2000,
              showConfirmButton: false
            });
            setTimeout(() => location.reload(), 2000);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo eliminar el archivo'
            });
          }
        })
        .catch(() => {
          Swal.fire({
            icon: 'error',
            title: 'Error de red',
            text: 'No se pudo conectar al servidor'
          });
        });
      }
    });
  }

  modalFondo.onclick = cerrarModal;
</script>
{% endblock %}
